extends layout/default_layout

block contents
  h1=title
    span.text-muted.ml-2.sub #{address}

  div#app(v-cloak)
    table.table.table-striped.table-bordered._table-sm.w-100
      thead
        tr
          th Transaction Count
          td 
            i.fas.fa-lg.fa-spinner.fa-pulse(v-if="transactionCount===null") 
            {{ transactionCount }}
        tr(v-if="isContract")
          th Data
          td
            //- textarea(disabled, readonly, rows="25") {{ code }}
            table.table.table-striped.table-bordered._table-sm.w-100
              thead
                tr
                  th SHID
                    td {{ shid }}
                tr
                  th 產出品項
                    td {{ title }}
                //- tr
                //-   th 產出作業
                //-     td {{ procedure }}
                tr
                  th 產出組織
                    td {{ organization }}
                tr
                  th 產出日期
                    td {{ producedDate }}
                tr
                  th 有效日期
                    td {{ expirationDate }}
                tr
                  th 目前數量
                    td {{ restNumber }}
                tr
                  th 產出數量
                    td {{ producedNumber }}
                tr
                  th 原料來源
                    td {{ sourceList }}
                tr
                  th 作為原料
                    td {{ destinationList }}
            //-     tr 
            //-     each t in #{transactions}
            //-       td=t
  
  script.

    var app = new Vue({
      el: '#app',
      data: { 
        address: '#{address}',
        itemJSON: '#{itemJSON}',
        balance: null,
        balance_eth: null,
        balance_usd: null,
        storage: null,
        code: null,
        transactionCount: null,
        shid: null,
        title: null,
        organization: null,
        producedDate: null,
        expirationDate: null,
        restNumber: null,
        producedNumber: null,
        sourceList: null,
        destinationList: null
      },
      computed: {
        isContract: function() {
          return (this.code && this.code.length > 3);
        }
      },
      created: function() {
        getAddressInfo.bind(this)();
      }
    });

    function getBalance(address) {
      return new Promise((res, rej) => {
        web3.eth.getBalance(address, (error, result) => {
          if(error) rej(error);
          else res(result.toString(10));
        });
      });
    }

    function getStorageAt(address) {
      return new Promise((res, rej) => {
        web3.eth.getStorageAt(address, (error, result) => {
          if(error) rej(error);
          else res(result);
        });
      });
    }

    function getCode(address) {
      return new Promise((res, rej) => {
        web3.eth.getCode(address, (error, result) => {
          if(error) rej(error);
          else res(result);
        });
      });
    }

    function getTransactionCount(address) {
      return new Promise((res, rej) => {
        web3.eth.getTransactionCount(address, (error, result) => {
          if(error) rej(error);
          else res(result);
        });
      });
    }


    function getETHUSD(balance) {
      return new Promise((res, rej) => {
        $.getJSON("https://api.coinmarketcap.com/v1/ticker/ethereum/", function(json) {
          var price = Number(json[0].price_usd);
          var ethusd = price.toFixed(2);
          var balanceusd = "$ " + (ethusd * balance);
          res(balanceusd);
        });
      });
    }

    async function getAddressInfo(address) {
      var self = app || this;
      address = address || self.address;

      //- self.balance = await getBalance(address);
      //- self.balance_eth = '(' + web3.fromWei(app.balance, 'ether').toString(10) + ' ETH)';
      self.balance_eth = "CCC"

      self.storage = await getStorageAt(address);
      self.code = await getCode(address);
      //- if( self.code.length > 3) self.isContract
      //- console.log('code: ', JSON.stringify(self.code, '', 2));

      self.transactionCount = await getTransactionCount(address);
      const itemjson = JSON.parse(self.itemJSON.replace(/&quot;/g,'"'))
      const itemFactory = new ethers.ContractFactory(
        itemjson.abi,
        itemjson.bytecode,
      );
      const signer = new ethers.Wallet("0x17bcf85e639fa3e467e99bef103e1401a12989bbee7d787409cae16d24191e21", GEtherProvider);
      const item = await itemFactory.connect(signer).attach(address)
      const itemData = await item.itemData();
      const quantity = await item.quantity();
      const sourceList = await item.getSourceList();
      const destinationList = await item.getDestinationList();
      console.log(sourceList)
      self.shid = itemData.shid
      self.title = itemData.name
      self.organization = itemData.organization
      console.log(parseInt(itemData.producedDate.toString(), 10))
      self.producedDate = new Date(parseInt(itemData.producedDate.toString(), 10) * 1000)
      self.expirationDate = new Date(parseInt(itemData.expirationDate.toString(), 10) * 1000)
      self.restNumber = quantity.restNumber;
      self.producedNumber = quantity.producedNumber;
      self.sourceList = sourceList.map((ele) => ele.usedObject).toString();
      self.destinationList = destinationList.map((ele) => ele.usedObject).toString();

      //- alert("AAA")
      //- self.organization ='(' + web3.fromWei(app.balance, 'ether').toString(10) + ' ETH)';
      //- console.log(itemABI)
      //- const item = new web3.eth.Contract(itemABI, address)
      //- const itemData = await item.itemData().call();
      //- console.log(itemData)
    }
